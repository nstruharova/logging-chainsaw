#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to you under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: chainsaw

on: [push, pull_request]

jobs:
  build:

    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ macos-latest ]

    steps:

      - name: Checkout repository
        uses: actions/checkout@v2

      # JDK 11 is needed for the build.
      # Search `maven-toolchains-plugin` usages for details.
      - name: Setup JDK 11
        uses: actions/setup-java@v2.4.0
        with:
          distribution: temurin
          java-version: 17
          java-package: jdk
          architecture: x64
          cache: maven

      - name: Initialize Energy Estimation
        uses: green-coding-berlin/eco-ci-energy-estimation@4eec5ab2253f0f13ce9dae785c06d9f8c88e6d44 # use hash or @vX here (See note below)
        with:
          task: start-measurement

      - name: Build with Maven
        run: mvn clean:clean compiler:compile -f pom.xml

      - name: Build measurement
        if: always()
        uses: green-coding-berlin/eco-ci-energy-estimation@4eec5ab2253f0f13ce9dae785c06d9f8c88e6d44 # use hash or @vX here (See note below)
        with:
          task: get-measurement
          label: 'Build measurement'

      - name: Show Energy Results
        if: always()
        uses: green-coding-berlin/eco-ci-energy-estimation@4eec5ab2253f0f13ce9dae785c06d9f8c88e6d44 # use hash or @vX here (See note below)
        id: total-measurement-step
        with:
          task: display-results

      - name: Upload total energy data artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: total-energy-data
          path: /tmp/eco-ci/total-data.json

      - name: Upload lap energy data artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: lap-energy-data
          path: /tmp/eco-ci/lap-data.json

      - name: Upload pom.xml artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pom.xml
          path: pom.xml

      - name: Inspect environment (Linux)
        if: runner.os == 'Linux'
        run: env | grep '^JAVA'

      - name: Inspect environment (Windows)
        if: runner.os == 'Windows'
        run: set java

      - name: Inspect environment (MacOS)
        if: runner.os == 'macOS'
        run: env | grep '^JAVA'

      - name: Maven "build"
        timeout-minutes: 60
        shell: bash
        run: |
          mvn site:site
          mvn install

#      - name: archive dmg
#        timeout-minutes: 60
#        shell: bash
#        run: find target -name \*.dmg
#
#      - uses: actions/upload-artifact@v3
#        with:
#          name: chainsaw.dmg
#          path: target/*.dmg
